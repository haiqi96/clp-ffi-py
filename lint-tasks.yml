version: "3"

vars:
  LINT_VENV_DIR: "{{.BUILD_DIR}}/lint-venv"
  LINT_VENV_CHECKSUM_FILE: "{{.G_BUILD_DIR}}/lint#venv.md5"

tasks:
  check:
    cmds:
      - task: "cmake-check"
      - task: "cpp-check"
      - task: "py-check"
      - task: "yml-check"

  fix:
    cmds:
      - task: "cmake-fix"
      - task: "cpp-fix"
      - task: "py-fix"
      - task: "yml-fix"

  cmake-check:
    deps: ["venv"]
    cmds:
      - task: "cmake"
        vars:
          FLAGS: "--check"

  cmake-fix:
    deps: ["venv"]
    cmds:
      - task: "cmake"
        vars:
          FLAGS: "--in-place"

  cpp-configs: "tools/yscope-dev-utils/lint-configs/symlink-cpp-lint-configs.sh"

  cpp-check:
      cmds:
        - task: "cpp-format-check"
        - task: "cpp-static-check"

  cpp-fix:
    cmds:
      - task: "cpp-format-fix"
      - task: "cpp-static-fix"

  cpp-format-check:
    sources: &cpp_format_src_files
      - "{{.LINT_VENV_CHECKSUM_FILE}}"
      - "src/clp_ffi_py/**/*.cpp"
      - "src/clp_ffi_py/**/*.h"
      - "src/clp_ffi_py/**/*.hpp"
      - "src/clp_ffi_py/**/*.inc"
      - "src/.clang-format"
      - "{{.TASKFILE}}"
      - ".clang-format"
    deps: ["cpp-configs", "venv"]
    cmds:
      - task: "clang-format"
        vars:
          FLAGS: "--dry-run"

  cpp-format-fix:
    sources: *cpp_format_src_files
    deps: ["cpp-configs", "venv"]
    cmds:
      - task: "clang-format"
        vars:
          FLAGS: "-i"

  py-check:
    cmds:
      - task: "py"
        vars:
          BLACK_FLAGS: "--check"
          RUFF_FLAGS: ""

  py-fix:
    cmds:
      - task: "py"
        vars:
          BLACK_FLAGS: ""
          RUFF_FLAGS: "--fix"

  yml:
    aliases:
      - "yml-check"
      - "yml-fix"
    deps: ["venv"]
    cmds:
      - |-
        . "{{.LINT_VENV_DIR}}/bin/activate"
        yamllint --strict \
          .github \
          .yamllint.yml \
          docs \
          lint-tasks.yml \
          src/.clang-format \
          Taskfile.yml

  cpp:
    internal: true
    requires:
      vars: ["FLAGS"]
    dir: "src"
    deps: ["cpp-configs", "venv"]
    cmds:
      - |-
        . "{{.LINT_VENV_DIR}}/bin/activate"
        find clp_ffi_py \
          -type f \
          \( -iname "*.cpp" -o -iname "*.h" -o -iname "*.hpp" -o -iname "*.inc" \) \
          -print0 | \
            xargs -0 clang-format {{.FLAGS}} -Werror

  py:
    internal: true
    requires:
      vars: ["BLACK_FLAGS", "RUFF_FLAGS"]
    deps: ["venv"]
    cmds:
      - for:
          - "clp_ffi_py"
          - "docs/conf"
        cmd: |-
          . "{{.LINT_VENV_DIR}}/bin/activate"
          cd "{{.ITEM}}"
          black --color --line-length 100 {{.BLACK_FLAGS}} .
          ruff check {{.RUFF_FLAGS}} .

  venv:
    internal: true
    vars:
      CHECKSUM_FILE: "{{.G_BUILD_DIR}}/{{.TASK | replace \":\" \"#\"}}.md5"
      OUTPUT_DIR: "{{.LINT_VENV_DIR}}"
    sources:
      - "{{.ROOT_DIR}}/Taskfile.yml"
      - "{{.TASKFILE}}"
      - "lint-requirements.txt"
    generates: ["{{.CHECKSUM_FILE}}"]
    deps:
      - ":init"
      - task: ":utils:validate-checksum"
        vars:
          CHECKSUM_FILE: "{{.CHECKSUM_FILE}}"
          DATA_DIR: "{{.OUTPUT_DIR}}"
    cmds:
      - task: ":utils:create-venv"
        vars:
          LABEL: "lint"
          OUTPUT_DIR: "{{.OUTPUT_DIR}}"
          REQUIREMENTS_FILE: "lint-requirements.txt"
      # This command must be last
      - task: ":utils:compute-checksum"
        vars:
          DATA_DIR: "{{.OUTPUT_DIR}}"
          OUTPUT_FILE: "{{.CHECKSUM_FILE}}"
